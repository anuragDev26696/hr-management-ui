<main class="container-xl py-3">
    <h1 class="visually-hidden">Projects</h1>
    <div class="card border-light">
        <div class="card-header border-light bg-white d-flex flex-wrap gap-2 align-items-center">
            <span  class="fs-5 fw-medium">Projects List <br><small class="small text-secondary fw-normal">{{projectList.length}} Projects</small></span>
            @if (isPermit) {
                <button class="btn btn-primary text-nowrap ms-auto" type="button" data-bs-toggle="modal" (click)="newForm($event)" data-bs-target="#projectFormModal"><i class="bi bi-plus"></i> New Project</button>
            }
        </div>
        <div class="card-body">
            <div class="col-sm-10 col-md-6 mb-3">
                <p class="input-group">
                    <input type="text" class="form-control" placeholder="Search project..." aria-label="Search project here" [formControl]="searchText" [readonly]="!listLoaded">
                    <button class="btn btn-primary" aria-label="Search by project" [disabled]="!listLoaded" (click)="triggerForNew($event)">
                        <i class="bi bi-search"></i>&nbsp; Search
                    </button>
                </p>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            @for (item of tableColumns; track $index) {
                                <th class="text-nowrap {{$first ? '' : 'cell_'+item.trim()}}">{{$first ? '#' : item | titlecase}}</th>
                            }
                        </tr>
                    </thead>
                    <tbody class="table-group-divider">
                        @for (project of filteredHolidayDataSubject | async; track project.uuid; let i = $index;) {
                            <tr>
                                @for (col of tableColumns; track col; let isFirst = $first;) {
                                    <td class="{{$first ? '' : 'cell_'+col.trim()}}">
                                        @if(['name', 'sr'].includes(col)){
                                            @if (col == 'name') {
                                                <app-profile-tile>
                                                    <profile-image [size]="40" [textImg]="project.name.slice(0,1)" [showStatus]="false"/>
                                                    <profile-title>{{project.name}}</profile-title>
                                                    <profile-subtitle><strong>Members:</strong> {{project.members || 0}}</profile-subtitle>
                                                </app-profile-tile>
                                            } @else {
                                                {{i+1}}
                                            }
                                        } @else if(col == 'description'){
                                            <span class="text-truncate">{{project.description}}</span>
                                        } @else {
                                            @if (isPermit) {
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#projectDetailModal" (click)="actionForMember($event, project, 'view')">View</button>
                                                    <button type="button" class="btn btn-primary btn-sm dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" [tabIndex]="-1" [attr.aria-controls]="'#event_'+i" aria-label="Options">
                                                        <span class="visually-hidden">Toggle Dropdown</span>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end border-light shadow rounded-3" [id]="'event_'+i">
                                                        <li><button class="dropdown-item small" data-bs-toggle="modal" data-bs-target="#projectFormModal" (click)="actionUpdate($event, project)">Update</button></li>
                                                        <li><button class="dropdown-item small" data-bs-toggle="modal" data-bs-target="#memberAsssignModal" (click)="actionForMember($event, project)">Add Member</button></li>
                                                        <li><button class="dropdown-item small danger-item" (click)="requestTrash($event, project.uuid)">Delete</button></li>
                                                    </ul>
                                                </div>
                                            }
                                        }
                                    </td>
                                }
                            </tr>
                        } @empty {
                            <tr>
                                <td class="py-3" [colSpan]="tableColumns.length">
                                    @if (listLoaded) {
                                        <p class="mt-3 text-center">Records not found.</p>
                                    } @else {
                                        <div class="d-flex align-items-center justify-content-center">
                                            <strong role="status">Loading...</strong>
                                            <div class="spinner-border spinner-border-sm ms-2" aria-hidden="true"></div>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Project Modal -->
<div class="modal fade" id="projectFormModal" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="projectFormModalLabel" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="projectFormModalLabel">{{projectData == null ? 'Create New' : 'Update'}} Project</h5>
          <button type="button" class="btn-close" [tabIndex]="-1" data-bs-dismiss="modal" aria-label="Close" data-bs-toggle="tooltip" title="Close modal" aria-label="Close table" [id]="'projectModalCloseBtn'"></button>
        </div>
        <div class="modal-body">
            <form [formGroup]="projectForm">
                <div class="mb-2">
                    <label for="projectNameCtrl" class="form-label">Project Name <span class="text-danger">*</span></label>
                    <input type="text" id="projectNameCtrl" class="form-control" [minLength]="3" [maxLength]="35" [class.is-invalid]="nameCtrl.touched && nameCtrl.invalid" [class.is-valid]="isValid(nameCtrl)" aria-describedby="projectNameCtrlFeed" formControlName="name" required>
                    <p class="invalid-feedback" id="projectNameCtrlFeed">
                        {{nameCtrl.invalid || nameCtrl.dirty ? 'Enter a valid name.' : 'Name is required.'}}
                    </p>
                </div>
                <div>
                    <label for="projectDescCtrl" class="form-label">Description <span class="text-danger">*</span></label>
                    <textarea id="projectDescCtrl" [rows]="4" class="form-control" [minLength]="5" [maxLength]="1500" [class.is-invalid]="descriptionCtrl.touched && descriptionCtrl.invalid" [class.is-valid]="isValid(descriptionCtrl)" aria-describedby="projectDescCtrlFeed" formControlName="description" required></textarea>
                    <p class="invalid-feedback" id="projectDescCtrlFeed">
                        @if (nameCtrl.touched) {
                            {{descriptionCtrl.invalid || descriptionCtrl.dirty ? 'Description should be 5-1500.' : 'Description is required.'}}
                        }
                    </p>
                </div>
            </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" [disabled]="projectForm.invalid || projectForm.disabled" (click)="onSubmit($event)">
            @if(projectForm.disabled){
                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                <span role="status">Loading...</span>
            } @else {Save changes}
          </button>
        </div>
      </div>
    </div>
</div>

<!-- Assign Project to employee -->
<div class="modal fade" id="memberAsssignModal" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="memberAsssignModalLabel" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-md-down modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="memberAsssignModalLabel">Add Member</h5>
          <button type="button" class="btn-close" [tabIndex]="-1" data-bs-dismiss="modal" aria-label="Close" data-bs-toggle="tooltip" title="Close modal" aria-label="Close table" [id]="'memberModalCloseBtn'"></button>
        </div>
        <div class="modal-body assignModalBody">
            <form [formGroup]="memberAssignFrom">
                <div class="mb-2">
                    <label for="assignMemberProject" class="form-label">Project Name</label>
                    <input type="text" id="assignMemberProject" [value]="projectData?.name!" class="form-control is-valid" readonly>
                </div>
                <div class="mb-3">
                    <label for="projectDescCtrl" class="form-label">Member <span class="text-danger">*</span></label>
                    <app-muli-select [multiple]="true" [errorMsg]="'Select at least on member'" formControlName="memberIds">
                        @for (item of userList; track item.uuid) {
                            <app-option [value]="item.uuid" [label]="item.name">{{item.name}}</app-option>
                        }
                    </app-muli-select>
                    @if (!userLoaded) {
                        <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" aria-hidden="true">
                            <div class="progress-bar progress-bar-striped progress-bar-animated w-100"></div>
                        </div>
                    }
                </div>
                <div class="mb-2">
                    <label for="membershipDate" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                    <input type="date" id="membershipDate" formControlName="expiryDate" class="form-control " [class.is-valid]="membershipDate.valid" [class.is-invalid]="membershipDate.touched && membershipDate.invalid" [required]="true">
                </div>
            </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" [disabled]="memberAssignFrom.invalid || memberAssignFrom.pending" (click)="assignMemebers($event)">
            @if(memberAssignFrom.pending){
                <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                <span role="status">Loading...</span>
            } @else {Save changes}
          </button>
        </div>
      </div>
    </div>
</div>

<!-- Project Detail -->
<div class="modal fade" id="projectDetailModal" aria-labelledby="projectDetailLabel" aria-hidden="true" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-md-down modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="projectDetailLabel"> 
                <profile-image [size]="30" [textImg]="projectData?.name?.slice(0,1) || ''" [showStatus]="false"/>
                {{projectData?.name || 'Project Detail'}}</h5>
          <button type="button" class="btn-close" [tabIndex]="-1" data-bs-dismiss="modal" aria-label="Close" data-bs-toggle="tooltip" title="Close modal" aria-label="Close table" [id]="'detailModalCloseBtn'"></button>
        </div>
        <div class="modal-body">
            <!-- <h3>{{projectData?.name}}</h3> -->
            <small class="text-muted"><strong>Created At:</strong> {{projectData?.createdAt | date}}</small> | 
            <small class="text-muted"><strong>Total Member: </strong>{{projectData?.members || 0}}</small><br><br>

            <h6 class="bg-body-secondary py-2 ps-3 rounded d-flex align-items-center justify-content-between">Project Description
                @if (projectData!=null) {
                    <button type="button" class="btn btn-link me-2 ms-auto fw-medium text-decoration-none" data-bs-toggle="modal" data-bs-target="#memberAsssignModal" (click)="actionForMember($event, projectData)"><i class="bi bi-plus"></i> Add Members</button>
                }
            </h6>
            <p class="project_description ps-3">{{projectData?.description}}</p>
            <div class="table-responsive pt-3 position-relative">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="table-active">Member</th>
                            <th class="table-active">Expiry Date</th>
                            <th class="table-active">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (item of projectMembers; track item.uuid) {
                            <tr>
                                <td class="text-truncate">
                                    <app-profile-tile>
                                        <profile-image [showStatus]="false" icon="bi bi-person-circle text-muted"/>
                                        <profile-title>{{item.employeeDetail?.name||"Unknown"}}</profile-title>
                                        <profile-subtitle>{{item.employeeDetail?.email || ""}}</profile-subtitle>
                                    </app-profile-tile>
                                </td>
                                <td class="text-nowrap">{{item.expiryDate | date}}</td>
                                <td class="text-nowrap"><button class="btn btn-sm btn-danger text-nowrap" (click)="trashMember($event, item.employeeId)"><i class="bi bi-trash"></i>&nbsp; Remove</button></td>
                            </tr>
                        } @empty {
                            <tr>
                                <td [colSpan]="3" class="py-2 text-center">
                                    @if (memberLoaded && projectData != null) {
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#memberAsssignModal" (click)="actionForMember($event, projectData)"><i class="bi bi-plus"></i>&nbsp; Add Members</button>
                                    } @else {
                                        <p class="d-flex gap-2 align-items-center justify-content-center">
                                            <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                                            <span role="status">Loading...</span>
                                        </p>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                @if (isDeleting) {
                    <div class="position-absolute top-0 start-0 w-100 h-100 z-2 d-flex gap-2 justify-content-center align-items-center fw-medium text-danger bg-danger bg-opacity-10">
                        <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>
                        <span role="status">Loading...</span>
                    </div>
                }
            </div>
        </div>
      </div>
    </div>
</div>